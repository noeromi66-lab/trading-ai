import type{MarketStructureAnalysis}from'./marketAnalysis.ts';export interface PairAnalysis{symbol:string;displayName:string;structure:MarketStructureAnalysis;currentPrice:number;priceChange24h:number}export interface ConfluenceResult{signalStrength:'strong'|'moderate'|'weak';confluenceScore:number;supportingPairs:string[];conflictingPairs:string[];reasoning:string}const CORRELATIONS:Record<string,{positive:string[];negative:string[]}>={'EURUSD':{positive:['EURJPY','EURGBP','AUDUSD'],negative:['USDCHF','USDJPY']},'GBPUSD':{positive:['GBPJPY','EURGBP','AUDUSD'],negative:['USDCHF','USDJPY']},'USDJPY':{positive:['USDCHF','EURUSD','GBPUSD'],negative:['EURJPY','GBPJPY','AUDJPY']},'GBPJPY':{positive:['GBPUSD','EURJPY','AUDJPY'],negative:['USDJPY']},'XAUUSD':{positive:['EURUSD','AUDUSD'],negative:['USDJPY','USDCHF']}};export function analyzeConfluence(targetSymbol:string,targetDirection:'bullish'|'bearish',allPairAnalyses:Record<string,PairAnalysis>):ConfluenceResult{const correlations=CORRELATIONS[targetSymbol];if(!correlations){return{signalStrength:'moderate',confluenceScore:50,supportingPairs:[],conflictingPairs:[],reasoning:`No correlation data available for ${targetSymbol}. Signal based on individual analysis only.`}}let confluenceScore=50;const supportingPairs:string[]=[];const conflictingPairs:string[]=[];for(const correlatedSymbol of correlations.positive){const analysis=allPairAnalyses[correlatedSymbol];if(!analysis)continue;const{structure}=analysis;const sameDirection=(targetDirection==='bullish'&&structure.trend==='bullish')||(targetDirection==='bearish'&&structure.trend==='bearish');if(sameDirection){confluenceScore+=10;supportingPairs.push(correlatedSymbol);if(structure.bos.detected)confluenceScore+=5;if(structure.liquiditySweep.detected)confluenceScore+=5}else if(structure.trend!=='sideways'){confluenceScore-=8;conflictingPairs.push(correlatedSymbol)}}for(const correlatedSymbol of correlations.negative){const analysis=allPairAnalyses[correlatedSymbol];if(!analysis)continue;const{structure}=analysis;const oppositeDirection=(targetDirection==='bullish'&&structure.trend==='bearish')||(targetDirection==='bearish'&&structure.trend==='bullish');if(oppositeDirection){confluenceScore+=10;supportingPairs.push(`${correlatedSymbol} (inverse)`);if(structure.bos.detected)confluenceScore+=5;if(structure.liquiditySweep.detected)confluenceScore+=5}else if(structure.trend!=='sideways'){confluenceScore-=8;conflictingPairs.push(`${correlatedSymbol} (inverse conflict)`)}}confluenceScore=Math.max(0,Math.min(100,confluenceScore));let signalStrength:'strong'|'moderate'|'weak';if(confluenceScore>=75){signalStrength='strong'}else if(confluenceScore>=55){signalStrength='moderate'}else{signalStrength='weak'}let reasoning=`${targetSymbol} ${targetDirection} signal `;if(supportingPairs.length>0){reasoning+=`confirmed by ${supportingPairs.length} correlated pair${supportingPairs.length>1?'s':''}: ${supportingPairs.slice(0,3).join(', ')}. `}if(conflictingPairs.length>0){reasoning+=`However, ${conflictingPairs.length} pair${conflictingPairs.length>1?'s show':' shows'} conflicting signals: ${conflictingPairs.slice(0,2).join(', ')}. `}if(signalStrength==='strong'){reasoning+='Strong multi-pair confluence indicates high institutional alignment.'}else if(signalStrength==='moderate'){reasoning+='Moderate confluence suggests cautious entry with tight risk management.'}else{reasoning+='Weak confluence signals potential divergence - consider waiting for clearer setup.'}return{signalStrength,confluenceScore,supportingPairs,conflictingPairs,reasoning}}export function generateMarketSentiment(allPairAnalyses:Record<string,PairAnalysis>):{overallBias:'risk-on'|'risk-off'|'neutral';dollarStrength:'strong'|'weak'|'neutral';yenStrength:'strong'|'weak'|'neutral';summary:string}{const pairs=Object.values(allPairAnalyses);if(pairs.length===0){return{overallBias:'neutral',dollarStrength:'neutral',yenStrength:'neutral',summary:'Insufficient data for market sentiment analysis.'}}let bullishCount=0;let bearishCount=0;pairs.forEach(analysis=>{if(analysis.structure.trend==='bullish')bullishCount++;if(analysis.structure.trend==='bearish')bearishCount++});const usdPairs=pairs.filter(p=>p.symbol.includes('USD')&&!p.symbol.includes('XAU'));let dollarBullish=0;let dollarBearish=0;usdPairs.forEach(analysis=>{const isUSDBase=analysis.symbol.startsWith('USD');if(isUSDBase){if(analysis.structure.trend==='bullish')dollarBullish++;if(analysis.structure.trend==='bearish')dollarBearish++}else{if(analysis.structure.trend==='bearish')dollarBullish++;if(analysis.structure.trend==='bullish')dollarBearish++}});const dollarStrength:'strong'|'weak'|'neutral'=dollarBullish>dollarBearish+1?'strong':dollarBearish>dollarBullish+1?'weak':'neutral';const jpyPairs=pairs.filter(p=>p.symbol.includes('JPY'));let yenBullish=0;let yenBearish=0;jpyPairs.forEach(analysis=>{const isJPYQuote=analysis.symbol.endsWith('JPY');if(isJPYQuote){if(analysis.structure.trend==='bearish')yenBullish++;if(analysis.structure.trend==='bullish')yenBearish++}});const yenStrength:'strong'|'weak'|'neutral'=yenBullish>yenBearish+1?'strong':yenBearish>yenBullish+1?'weak':'neutral';const totalPairs=pairs.length;const bullishPercent=(bullishCount/totalPairs)*100;let overallBias:'risk-on'|'risk-off'|'neutral';if(bullishPercent>=60){overallBias='risk-on'}else if(bullishPercent<=40){overallBias='risk-off'}else{overallBias='neutral'}let summary=`Market Sentiment: `;if(overallBias==='risk-on'){summary+=`Risk-on environment with ${bullishCount}/${totalPairs} pairs showing bullish structure. `}else if(overallBias==='risk-off'){summary+=`Risk-off environment with ${bearishCount}/${totalPairs} pairs showing bearish structure. `}else{summary+=`Mixed market with balanced bullish (${bullishCount}) and bearish (${bearishCount}) signals. `}summary+=`Dollar is ${dollarStrength}`;if(dollarStrength!=='neutral'){summary+=` across major pairs`}summary+=`. `;summary+=`Yen showing ${yenStrength} characteristics`;if(yenStrength==='strong'){summary+=` (safe-haven bid)`}else if(yenStrength==='weak'){summary+=` (risk appetite)`}summary+=`.`;return{overallBias,dollarStrength,yenStrength,summary}}