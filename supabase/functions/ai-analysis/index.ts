import "jsr:@supabase/functions-js/edge-runtime.d.ts";import { createClient } from "npm:@supabase/supabase-js@2.57.4";import { fetchMultiTimeframeData, analyzeMarketStructure, type PairAnalysis } from './marketAnalysis.ts';import { analyzeConfluence, generateMarketSentiment } from './confluenceAnalysis.ts';const corsHeaders={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-Client-Info, Apikey"};const SYSTEM_PROMPT=`You are an elite ICT/SMC trading expert with 10+ years of experience at top prop firms.

Generate EXACTLY 6-8 SHORT, actionable market insights (1-3 sentences each) that traders can swipe through on mobile.
Each insight MUST be standalone, impactful, and tactical.

CRITICAL: Return insights as a numbered list (1., 2., 3., etc.) with ONE insight per line.

Focus on:
- Current market structure and institutional behavior
- Specific trading opportunities with clear direction
- Key levels and smart money footprints
- Risk management and timing advice
- Multi-pair confluence observations

Keep each insight concise, confident, and immediately actionable. Use bold text (**text**) for emphasis on key terms.`;async function analyzePair(symbol:string,displayName:string,polygonKey:string):Promise<PairAnalysis|null>{try{const mtfData=await fetchMultiTimeframeData(symbol,polygonKey);if(!mtfData.M15||mtfData.M15.length<50){return null}const structure=analyzeMarketStructure(mtfData.M15);const lastCandle=mtfData.M15[mtfData.M15.length-1];const firstCandle=mtfData.M15[0];const priceChange24h=((lastCandle.close-firstCandle.close)/firstCandle.close)*100;return{symbol,displayName,structure,currentPrice:lastCandle.close,priceChange24h}}catch(error){console.error(`Error analyzing ${symbol}:`,error);return null}}function generateShortInsights(signals:any[],pairAnalyses:Record<string,PairAnalysis>,marketSentiment:any):string[]{const insights:string[]=[];insights.push(`**Market Sentiment:** ${marketSentiment.summary}`);for(const signal of signals.slice(0,3)){const pairSymbol=signal.trading_pairs?.symbol||'Unknown';const pairAnalysis=pairAnalyses[pairSymbol];if(!pairAnalysis)continue;const{structure}=pairAnalysis;const direction=signal.signal_type==='BUY'?'bullish':signal.signal_type==='SELL'?'bearish':null;if(direction){const confluence=analyzeConfluence(pairSymbol,direction,pairAnalyses);let insight=`**${pairAnalysis.displayName} ${signal.signal_type}** (Grade ${signal.grade}, ${Math.round(signal.confidence_score)}%): `;if(structure.bos.detected){insight+=`${structure.bos.type} BOS at ${structure.bos.breakLevel?.toFixed(5)}. `}if(structure.liquiditySweep.detected){insight+=`Liquidity sweep detected - institutional manipulation confirmed. `}insight+=`Confluence: ${confluence.signalStrength.toUpperCase()}.`;insights.push(insight)}if(structure.orderBlocks.length>0&&insights.length<7){const ob=structure.orderBlocks[0];insights.push(`**${pairAnalysis.displayName}** order block at ${ob.price.toFixed(5)} - watch for institutional reaction at this level.`)}if(structure.fvgs.length>0&&insights.length<7){const fvg=structure.fvgs[0];insights.push(`**${pairAnalysis.displayName}** FVG between ${fvg.bottom.toFixed(5)}-${fvg.top.toFixed(5)} acting as ${fvg.type==='bullish'?'support':'resistance'}.`)}}if(marketSentiment.dollarStrength!=='neutral'&&insights.length<8){insights.push(`**Dollar ${marketSentiment.dollarStrength}** across majors - ${marketSentiment.dollarStrength==='strong'?'favor USD longs':'consider USD shorts'}.`)}if(marketSentiment.yenStrength!=='neutral'&&insights.length<8){insights.push(`**Yen ${marketSentiment.yenStrength}** - ${marketSentiment.yenStrength==='strong'?'risk-off sentiment':'risk appetite'} driving JPY pairs.`)}const now=new Date();const hour=now.getUTCHours();if(hour>=7&&hour<10&&insights.length<8){insights.push(`**London Killzone Active** (07:00-10:30 UTC) - prime time for institutional entries. Watch for liquidity grabs.`)}else if(hour>=12&&hour<15&&insights.length<8){insights.push(`**New York Killzone Active** (13:45-17:00 UTC) - high probability setups forming. Smart money is moving.`)}else if(insights.length<8){insights.push(`**Outside killzone hours** - lower volume period. Wait for London (07:00 UTC) or New York (13:45 UTC) for best setups.`)}while(insights.length<5){insights.push('**Risk Management:** Never risk more than 1-2% per trade. Protect your capital first, profits second.')}return insights.slice(0,8)}function generateFallbackInsights(pairAnalyses:Record<string,PairAnalysis>,marketSentiment:any):string[]{const insights:string[]=[];insights.push(`**Market Sentiment:** ${marketSentiment.summary}`);insights.push('**No Active Signals** - Market consolidating. Waiting for clear institutional commitment before entry.');const pairs=Object.values(pairAnalyses);const bullishPairs=pairs.filter(p=>p.structure.trend==='bullish').slice(0,2);const bearishPairs=pairs.filter(p=>p.structure.trend==='bearish').slice(0,2);if(bullishPairs.length>0){insights.push(`**Bullish Structure** on ${bullishPairs.map(p=>p.displayName).join(', ')} - watch for breakout opportunities on these pairs.`)}if(bearishPairs.length>0){insights.push(`**Bearish Structure** on ${bearishPairs.map(p=>p.displayName).join(', ')} - potential short setups forming.`)}insights.push('**Patience Wins** - The best traders wait for high-probability setups. Quality over quantity always.');const now=new Date();const hour=now.getUTCHours();if(hour>=7&&hour<10){insights.push(`**London Killzone** (07:00-10:30 UTC) is active - prime time for institutional moves.`)}else if(hour>=12&&hour<15){insights.push(`**New York Killzone** (13:45-17:00 UTC) is active - watch for smart money entries.`)}else{insights.push(`**Wait for Killzone** - London opens 07:00 UTC, New York 13:45 UTC. Best setups form during these windows.`)}insights.push('**Risk First** - Always calculate your stop loss before entry. Never enter without knowing your max risk.');return insights.slice(0,8)}Deno.serve(async(req:Request)=>{if(req.method==="OPTIONS"){return new Response(null,{status:200,headers:corsHeaders})}try{const{signals}=await req.json();const supabaseUrl=Deno.env.get("SUPABASE_URL")!;const supabaseKey=Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;const polygonKey=Deno.env.get("POLYGON_API_KEY")||"_OSxpOFyFmoejpLLo1qnJ7r4e4Ajie9F";const openaiKey=Deno.env.get("OPENAI_API_KEY")||"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";const supabase=createClient(supabaseUrl,supabaseKey);console.log('Starting ICT/SMC market analysis...');const{data:tradingPairs}=await supabase.from('trading_pairs').select('*').eq('is_active',true);const pairAnalyses:Record<string,PairAnalysis>={};if(tradingPairs){for(const pair of tradingPairs){const analysis=await analyzePair(pair.symbol,pair.display_name,polygonKey);if(analysis){pairAnalyses[pair.symbol]=analysis}await new Promise(resolve=>setTimeout(resolve,150))}}console.log(`Analyzed ${Object.keys(pairAnalyses).length} pairs`);const marketSentiment=generateMarketSentiment(pairAnalyses);let baseInsights:string[];if(!signals||signals.length===0){baseInsights=generateFallbackInsights(pairAnalyses,marketSentiment)}else{baseInsights=generateShortInsights(signals,pairAnalyses,marketSentiment)}const signalsData=signals?.slice(0,5).map((s:any)=>({pair:s.trading_pairs?.symbol||'Unknown',signal:s.signal_type,confidence:s.confidence_score,grade:s.grade,bos:pairAnalyses[s.trading_pairs?.symbol]?.structure.bos.detected,sweep:pairAnalyses[s.trading_pairs?.symbol]?.structure.liquiditySweep.detected}));const userMessage=`Market Data:
Signals: ${JSON.stringify(signalsData||[],null,2)}
Sentiment: ${marketSentiment.summary}

Generate EXACTLY 6-8 SHORT trading insights (1-3 sentences each) as a numbered list.
Include specific pairs, directions, ICT/SMC observations, and timing advice.
Use **bold** for key terms.`;console.log('Requesting GPT-4 insights...');let finalThoughts:string[];try{const response=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Authorization":`Bearer ${openaiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4-turbo-preview",messages:[{role:"system",content:SYSTEM_PROMPT},{role:"user",content:userMessage}],temperature:0.7,max_tokens:1200})});if(response.ok){const data=await response.json();const gptContent=data.choices[0]?.message?.content||"";const gptInsights=gptContent.split('\n').filter((line:string)=>line.trim().length>25).map((line:string)=>line.replace(/^\d+\.\s*/,'').replace(/^[-â€¢*]\s*/,'').trim()).filter((line:string)=>line.length>0&&!line.startsWith('#'));if(gptInsights.length>=5){finalThoughts=gptInsights.slice(0,8);console.log(`GPT-4 generated ${finalThoughts.length} insights`)}else{console.log('GPT-4 returned insufficient insights, using base insights');finalThoughts=baseInsights}}else{console.error('GPT-4 API error, using base insights');finalThoughts=baseInsights}}catch(gptError){console.error('GPT-4 request failed:',gptError);finalThoughts=baseInsights}if(finalThoughts.length<5){finalThoughts=[...finalThoughts,...baseInsights].slice(0,8)}if(finalThoughts.length<5){finalThoughts=[`**Market Sentiment:** ${marketSentiment.summary}`,'**Analysis in progress** - ICT/SMC structures being evaluated across all pairs.','**Patience is key** - Wait for clear Break of Structure and liquidity confirmation.','**Risk Management** - Never risk more than 1-2% per trade. Capital preservation first.',`**Session Timing** - Best setups during London (07:00 UTC) and New York (13:45 UTC) killzones.`]}console.log(`Returning ${finalThoughts.length} insights`);return new Response(JSON.stringify({analysis:`AI Market Intelligence: ${finalThoughts.length} insights available`,thoughts:finalThoughts}),{status:200,headers:{...corsHeaders,"Content-Type":"application/json"}})}catch(error){console.error("AI analysis error:",error);return new Response(JSON.stringify({error:error.message,analysis:'Analysis temporarily unavailable',thoughts:['**System Notice:** Market analysis is temporarily unavailable. Please try again.','**Tip:** Use multiple timeframes for confirmation - M15, H1, H4 alignment increases probability.','**Risk Management:** Always know your stop loss before entering any position.','**Session Awareness:** London (07:00 UTC) and New York (13:45 UTC) offer best liquidity.','**Patience Pays:** Quality setups over quantity. Wait for institutional confirmation.']}),{status:500,headers:{...corsHeaders,"Content-Type":"application/json"}})}});