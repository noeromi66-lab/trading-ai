import "jsr:@supabase/functions-js/edge-runtime.d.ts";import { createClient } from "npm:@supabase/supabase-js@2.57.4";import { fetchMultiTimeframeData, analyzeMarketStructure, type PairAnalysis } from './marketAnalysis.ts';import { analyzeConfluence, generateMarketSentiment } from './confluenceAnalysis.ts';const corsHeaders={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-Client-Info, Apikey"};const SYSTEM_PROMPT=`You are an elite ICT/SMC trading expert with 10+ years of experience at top prop firms.

Generate 5-8 SHORT, actionable market insights (1-3 sentences each) that traders can swipe through on mobile.
Each insight should be standalone, impactful, and tactical.

Focus on:
- Current market structure and institutional behavior
- Specific trading opportunities with clear direction
- Key levels and smart money footprints
- Risk management and timing advice
- Multi-pair confluence observations

Keep each insight concise, confident, and immediately actionable. Use bold text (**text**) for emphasis on key terms.`;async function analyzePair(symbol:string,displayName:string,polygonKey:string):Promise<PairAnalysis|null>{try{const mtfData=await fetchMultiTimeframeData(symbol,polygonKey);if(!mtfData.M15||mtfData.M15.length<50){return null}const structure=analyzeMarketStructure(mtfData.M15);const lastCandle=mtfData.M15[mtfData.M15.length-1];const firstCandle=mtfData.M15[0];const priceChange24h=((lastCandle.close-firstCandle.close)/firstCandle.close)*100;return{symbol,displayName,structure,currentPrice:lastCandle.close,priceChange24h}}catch(error){console.error(`Error analyzing ${symbol}:`,error);return null}}function generateShortInsights(signals:any[],pairAnalyses:Record<string,PairAnalysis>,marketSentiment:any):string[]{const insights:string[]=[];insights.push(`**Market Sentiment:** ${marketSentiment.summary}`);for(const signal of signals.slice(0,3)){const pairSymbol=signal.trading_pairs?.symbol||'Unknown';const pairAnalysis=pairAnalyses[pairSymbol];if(!pairAnalysis)continue;const{structure}=pairAnalysis;const direction=signal.signal_type==='BUY'?'bullish':signal.signal_type==='SELL'?'bearish':null;if(direction){const confluence=analyzeConfluence(pairSymbol,direction,pairAnalyses);let insight=`**${pairAnalysis.displayName} ${signal.signal_type}** (Grade ${signal.grade}, ${Math.round(signal.confidence_score)}%): `;if(structure.bos.detected){insight+=`${structure.bos.type} BOS detected at ${structure.bos.breakLevel?.toFixed(5)}. `}if(structure.liquiditySweep.detected){insight+=`Liquidity sweep on ${structure.liquiditySweep.sweptType}s - institutional manipulation confirmed. `}insight+=`Confluence: ${confluence.signalStrength.toUpperCase()}`;insights.push(insight)}if(structure.orderBlocks.length>0){const ob=structure.orderBlocks[0];insights.push(`**${pairAnalysis.displayName}** has a ${ob.type} order block at ${ob.price.toFixed(5)} - watch for reaction at this institutional level.`)}if(structure.fvgs.length>0){const fvg=structure.fvgs[0];insights.push(`**${pairAnalysis.displayName}** Fair Value Gap between ${fvg.bottom.toFixed(5)}-${fvg.top.toFixed(5)} may act as ${fvg.type==='bullish'?'support':'resistance'}.`)}}if(marketSentiment.dollarStrength!=='neutral'){insights.push(`**Dollar** showing ${marketSentiment.dollarStrength} characteristics across majors - ${marketSentiment.dollarStrength==='strong'?'favor USD pairs long':'consider USD pairs short'}.`)}if(marketSentiment.yenStrength!=='neutral'){insights.push(`**Yen** ${marketSentiment.yenStrength==='strong'?'strength indicates risk-off':'weakness suggests risk appetite'} - JPY pairs aligned with ${marketSentiment.yenStrength==='strong'?'safe-haven flows':'carry trade dynamics'}.`)}const pairs=Object.values(pairAnalyses).slice(0,4);for(const pair of pairs){const{structure}=pair;if(structure.bos.detected||structure.liquiditySweep.detected){let insight=`**${pair.displayName}**: ${structure.trend.toUpperCase()} trend`;if(structure.bos.detected)insight+=`, ${structure.bos.type} BOS`;if(structure.liquiditySweep.detected)insight+=`, liquidity sweep detected`;insights.push(insight+'.')}}return insights.slice(0,8)}function generateFallbackInsights(pairAnalyses:Record<string,PairAnalysis>,marketSentiment:any):string[]{const insights:string[]=[];insights.push(marketSentiment.summary);insights.push('**No active signals** - Market in consolidation. Waiting for clear institutional commitment before entry.');const pairs=Object.values(pairAnalyses);const bullishPairs=pairs.filter(p=>p.structure.trend==='bullish').slice(0,2);const bearishPairs=pairs.filter(p=>p.structure.trend==='bearish').slice(0,2);if(bullishPairs.length>0){insights.push(`**Bullish structures** on ${bullishPairs.map(p=>p.displayName).join(', ')} - watch for breakout opportunities.`)}if(bearishPairs.length>0){insights.push(`**Bearish structures** on ${bearishPairs.map(p=>p.displayName).join(', ')} - potential short setups forming.`)}insights.push('**Patience is key** in trading. Best setups require institutional alignment across multiple timeframes.');return insights}Deno.serve(async(req:Request)=>{if(req.method==="OPTIONS"){return new Response(null,{status:200,headers:corsHeaders})}try{const{signals}=await req.json();const supabaseUrl=Deno.env.get("SUPABASE_URL")!;const supabaseKey=Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;const polygonKey=Deno.env.get("POLYGON_API_KEY")||"_OSxpOFyFmoejpLLo1qnJ7r4e4Ajie9F";const openaiKey=Deno.env.get("OPENAI_API_KEY")||"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";const supabase=createClient(supabaseUrl,supabaseKey);console.log('Starting ICT/SMC market analysis...');const{data:tradingPairs}=await supabase.from('trading_pairs').select('*').eq('is_active',true);const pairAnalyses:Record<string,PairAnalysis>={};if(tradingPairs){for(const pair of tradingPairs){const analysis=await analyzePair(pair.symbol,pair.display_name,polygonKey);if(analysis){pairAnalyses[pair.symbol]=analysis}await new Promise(resolve=>setTimeout(resolve,150))}}console.log(`Analyzed ${Object.keys(pairAnalyses).length} pairs`);const marketSentiment=generateMarketSentiment(pairAnalyses);let baseInsights:string[];if(!signals||signals.length===0){baseInsights=generateFallbackInsights(pairAnalyses,marketSentiment)}else{baseInsights=generateShortInsights(signals,pairAnalyses,marketSentiment)}const signalsData=signals?.slice(0,5).map((s:any)=>({pair:s.trading_pairs?.symbol||'Unknown',signal:s.signal_type,confidence:s.confidence_score,grade:s.grade,structure:pairAnalyses[s.trading_pairs?.symbol]?.structure}));const userMessage=`Current market data:

Signals: ${JSON.stringify(signalsData||[],null,2)}

Market Sentiment: ${marketSentiment.summary}

Generate 5-8 SHORT, swipable trading insights (1-3 sentences each). Each should be standalone and tactical.
Include:
- Key trading opportunities with specific pairs and direction
- ICT/SMC observations (BOS, liquidity sweeps, order blocks)
- Multi-pair confluence notes
- Risk management tips
- Timing/session advice

Keep each insight punchy and actionable. Use **bold** for key terms.`;console.log('Requesting GPT-4 enhanced insights...');const response=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Authorization":`Bearer ${openaiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4-turbo-preview",messages:[{role:"system",content:SYSTEM_PROMPT},{role:"user",content:userMessage}],temperature:0.7,max_tokens:1000})});let finalThoughts:string[];if(response.ok){const data=await response.json();const gptContent=data.choices[0]?.message?.content||"";const gptInsights=gptContent.split('\n').filter((line:string)=>line.trim().length>30).map((line:string)=>line.replace(/^[-â€¢*\d.]+\s*/,'').trim()).filter((line:string)=>line.length>0);finalThoughts=[...gptInsights.slice(0,6),...baseInsights.slice(0,3)].slice(0,8);console.log('GPT-4 enhanced insights generated')}else{console.error('GPT-4 API error, using base insights');finalThoughts=baseInsights}if(finalThoughts.length===0){finalThoughts=[marketSentiment.summary,'Market analysis in progress. Check back in a moment.','**Patience** is the key to consistent profitability in trading.']}const summary=`Market Intelligence: ${finalThoughts.length} insights available. ${marketSentiment.summary}`;return new Response(JSON.stringify({analysis:summary,thoughts:finalThoughts}),{status:200,headers:{...corsHeaders,"Content-Type":"application/json"}})}catch(error){console.error("AI analysis error:",error);return new Response(JSON.stringify({error:error.message,thoughts:['Unable to analyze market at this time. Please try again.']}),{status:500,headers:{...corsHeaders,"Content-Type":"application/json"}})}});